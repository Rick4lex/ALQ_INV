import{b as le,r,j as e,M as ce,q as K,s as de,A as I,H as pe,v as he}from"./index-CIMXU-Ls.js";/**
 * @license lucide-react v0.395.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=le("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]),me=["variant_sku","variant_price","variant_cost","variant_stock"],xe=({isOpen:O,onClose:Q,products:D,onImport:W})=>{const[j,c]=r.useState("idle"),[X,m]=r.useState(""),[J,u]=r.useState(!1),[x,_]=r.useState([]),[N,z]=r.useState([]),[Y,P]=r.useState(0),[b,A]=r.useState([]),Z=r.useMemo(()=>{const s=new Map;return D.forEach(d=>{d.variants.forEach(g=>{g.sku&&s.set(g.sku,{product:d,variant:g})})}),s},[D]),ee=()=>{c("idle"),m(""),u(!1),_([]),z([]),P(0),A([])},M=()=>{ee(),Q()},se=s=>{c("parsing");const d=new FileReader;d.onload=g=>{var F;try{const y=((F=g.target)==null?void 0:F.result).split(/\r?\n/).filter(t=>t.trim()!=="");if(y.length<2)throw new Error("El archivo CSV está vacío o solo contiene la cabecera.");const q=y[0].split(",").map(t=>t.trim()),U=me.filter(t=>!q.includes(t));if(U.length>0)throw new Error(`Faltan las siguientes cabeceras requeridas: ${U.join(", ")}`);const oe=y.slice(1),V=[],H=[],$=[];let B=0;oe.forEach((t,ne)=>{var G;const ie=((G=t.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g))==null?void 0:G.map(h=>h.replace(/^"|"$/g,"").replace(/""/g,'"')))||[],C={};q.forEach((h,a)=>{var l;return C[h]=(l=ie[a])==null?void 0:l.trim()});const{variant_sku:L,variant_price:w,variant_cost:k,variant_stock:S}=C,p=[],E=L?Z.get(L):void 0;E||p.push("SKU no encontrado en el catálogo.");const o=w!==""?parseFloat(w):void 0;w!==""&&(o===void 0||isNaN(o)||o<0)&&p.push("Precio inválido.");const n=k!==""?parseFloat(k):void 0;k!==""&&(n===void 0||isNaN(n)||n<0)&&p.push("Costo inválido.");const i=S!==""?parseInt(S,10):void 0;if(S!==""&&(i===void 0||isNaN(i)||i<0)&&p.push("Stock inválido."),p.length>0){H.push({data:C,rowIndex:ne+2,errors:p});return}if(E){const{product:h,variant:a}=E,l={productId:h.id,productTitle:h.title,variantId:a.id,variantName:a.name,sku:a.sku},v={variantId:a.id};let f=!1;o!==void 0&&o!==a.price&&(l.priceChange={from:a.price||0,to:o},v.newPrice=o,f=!0),n!==void 0&&n!==a.cost&&(l.costChange={from:a.cost||0,to:n},v.newCost=n,f=!0),i!==void 0&&i!==a.stock&&(l.stockChange={from:a.stock,to:i},v.newStock=i,f=!0),f?(V.push(l),$.push(v)):B++}}),_(V),z(H),P(B),A($),c("preview")}catch(T){c("error"),m(T.message||"Error desconocido al procesar el archivo.")}},d.onerror=()=>{c("error"),m("No se pudo leer el archivo.")},d.readAsText(s)},R=s=>{s&&(s.type==="text/csv"||s.name.endsWith(".csv"))?se(s):(c("error"),m("Por favor, selecciona un archivo .csv válido."))},ae=s=>{s.preventDefault(),s.stopPropagation(),u(!1),R(s.dataTransfer.files?s.dataTransfer.files[0]:null)},re=()=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-3 text-sm bg-gray-900/50 rounded-lg border border-gray-700",children:[e.jsx("p",{className:"font-semibold mb-2",children:"Instrucciones:"}),e.jsxs("ul",{className:"list-disc list-inside text-gray-300 space-y-1 text-xs",children:[e.jsx("li",{children:'Exporta el CSV completo desde el panel financiero (Botón "Exportar CSV").'}),e.jsx("li",{children:"Abre el archivo y modifica **únicamente** los valores en las columnas `variant_price`, `variant_cost` y `variant_stock`."}),e.jsx("li",{children:"No modifiques ninguna otra columna, especialmente `variant_sku`."}),e.jsx("li",{children:"Guarda los cambios y sube el archivo modificado aquí."})]})]}),e.jsxs("div",{onDragEnter:s=>{s.preventDefault(),s.stopPropagation(),u(!0)},onDragLeave:s=>{s.preventDefault(),s.stopPropagation(),u(!1)},onDragOver:s=>{s.preventDefault(),s.stopPropagation()},onDrop:ae,className:`mt-4 flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg cursor-pointer transition-colors ${J?"border-purple-400 bg-purple-900/30":"border-gray-600 hover:border-gray-500"}`,onClick:()=>{var s;return(s=document.getElementById("csvFileInput"))==null?void 0:s.click()},children:[e.jsx(he,{size:40,className:"text-gray-400 mb-2"}),e.jsx("span",{className:"text-gray-300",children:"Arrastra y suelta el archivo .csv aquí"}),e.jsx("span",{className:"text-sm text-gray-500",children:"o haz clic para seleccionar"}),e.jsx("input",{id:"csvFileInput",type:"file",accept:".csv",className:"hidden",onChange:s=>R(s.target.files?s.target.files[0]:null)})]}),j==="error"&&e.jsx("p",{className:"mt-4 text-center text-red-400 bg-red-900/50 p-3 rounded-lg",children:X})]}),te=()=>e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap justify-around p-3 bg-gray-900/50 rounded-lg text-center text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"text-green-500"})," ",e.jsx("span",{className:"font-bold",children:x.length})," variantes para actualizar"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(de,{className:"text-red-500"})," ",e.jsx("span",{className:"font-bold",children:N.length})," filas con errores"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"text-gray-500"})," ",e.jsx("span",{className:"font-bold",children:Y})," filas sin cambios"]})]}),x.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2 text-gray-300",children:"Previsualización de Cambios:"}),e.jsx("div",{className:"max-h-60 overflow-y-auto bg-gray-900/80 p-2 rounded-lg border border-gray-700 space-y-2",children:x.map(s=>e.jsxs("div",{className:"p-2 bg-gray-800/70 rounded",children:[e.jsxs("p",{className:"font-bold text-sm",children:[s.productTitle," ",e.jsxs("span",{className:"text-purple-400",children:["(",s.variantName,")"]})]}),e.jsxs("div",{className:"text-xs text-gray-400 grid grid-cols-3 gap-x-2",children:[s.priceChange&&e.jsxs("span",{children:["Precio: ",s.priceChange.from," ",e.jsx(I,{size:12,className:"inline"})," ",s.priceChange.to]}),s.costChange&&e.jsxs("span",{children:["Costo: ",s.costChange.from," ",e.jsx(I,{size:12,className:"inline"})," ",s.costChange.to]}),s.stockChange&&e.jsxs("span",{className:"flex items-center gap-1",children:["Stock: ",s.stockChange.from," ",e.jsx(I,{size:12,className:"inline"})," ",s.stockChange.to," ",e.jsx("span",{title:"Se creará un ajuste de historial",children:e.jsx(pe,{size:12,className:"text-yellow-400"})})]})]})]},s.variantId))})]}),N.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold mb-2 text-yellow-400 flex items-center gap-2",children:[e.jsx(ge,{size:18})," Errores (filas ignoradas):"]}),e.jsx("div",{className:"max-h-32 overflow-y-auto bg-gray-900/80 p-2 rounded-lg border border-gray-700",children:e.jsx("ul",{className:"text-xs space-y-1",children:N.map(s=>e.jsxs("li",{children:["Fila ",s.rowIndex,": ",e.jsx("span",{className:"text-red-400",children:s.errors.join(", ")})]},s.rowIndex))})})]}),x.length===0&&e.jsx("p",{className:"text-center text-yellow-400 bg-yellow-900/50 p-4 rounded-lg",children:"No se encontraron cambios válidos para aplicar. Revisa tu archivo CSV."})]});return e.jsxs(ce,{isOpen:O,onClose:M,title:"Importar y Actualizar desde CSV",size:"lg",children:[e.jsx("div",{className:"p-6 space-y-4",children:j==="preview"?te():re()}),e.jsxs("footer",{className:"flex justify-end gap-4 p-4 border-t border-gray-700",children:[e.jsx("button",{type:"button",onClick:M,className:"py-2 px-4 bg-gray-600 hover:bg-gray-500 rounded-md transition-colors",children:"Cancelar"}),j==="preview"&&e.jsxs("button",{type:"button",onClick:()=>W(b),disabled:b.length===0,className:"py-2 px-4 bg-brand-purple hover:bg-purple-600 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:["Confirmar y Aplicar ",b.length," Cambio(s)"]})]})]})};export{xe as default};

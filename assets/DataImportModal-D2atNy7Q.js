import{u as le,r,j as e,p as L,q as ce,A as D,H as de}from"./index-YKwopWJT.js";import{M as pe}from"./Modal-D7kRee5V.js";import{T as me}from"./triangle-alert-DDjViyo7.js";import{C as he}from"./cloud-upload-B4RycofI.js";const ge=["variant_sku","variant_price","variant_cost","variant_stock"],je=({isOpen:O,onClose:Q})=>{const{products:g,handleCsvImport:W}=le(),[N,c]=r.useState("idle"),[X,u]=r.useState(""),[J,x]=r.useState(!1),[v,_]=r.useState([]),[b,P]=r.useState([]),[Y,z]=r.useState(0),[y,A]=r.useState([]),Z=r.useMemo(()=>{const s=new Map;return g==null||g.forEach(d=>{d.variants.forEach(h=>{h.sku&&s.set(h.sku,{product:d,variant:h})})}),s},[g]),ee=()=>{c("idle"),u(""),x(!1),_([]),P([]),z(0),A([])},R=()=>{ee(),Q()},se=s=>{c("parsing");const d=new FileReader;d.onload=h=>{var F;try{const C=((F=h.target)==null?void 0:F.result).split(/\r?\n/).filter(t=>t.trim()!=="");if(C.length<2)throw new Error("El archivo CSV está vacío o solo contiene la cabecera.");const U=C[0].split(",").map(t=>t.trim()),V=ge.filter(t=>!U.includes(t));if(V.length>0)throw new Error(`Faltan las siguientes cabeceras requeridas: ${V.join(", ")}`);const oe=C.slice(1),q=[],H=[],$=[];let B=0;oe.forEach((t,ne)=>{var K;const ie=((K=t.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g))==null?void 0:K.map(m=>m.replace(/^"|"$/g,"").replace(/""/g,'"')))||[],w={};U.forEach((m,a)=>{var l;return w[m]=(l=ie[a])==null?void 0:l.trim()});const{variant_sku:G,variant_price:k,variant_cost:S,variant_stock:E}=w,p=[],I=G?Z.get(G):void 0;I||p.push("SKU no encontrado en el catálogo.");const o=k!==""?parseFloat(k):void 0;k!==""&&(o===void 0||isNaN(o)||o<0)&&p.push("Precio inválido.");const n=S!==""?parseFloat(S):void 0;S!==""&&(n===void 0||isNaN(n)||n<0)&&p.push("Costo inválido.");const i=E!==""?parseInt(E,10):void 0;if(E!==""&&(i===void 0||isNaN(i)||i<0)&&p.push("Stock inválido."),p.length>0){H.push({data:w,rowIndex:ne+2,errors:p});return}if(I){const{product:m,variant:a}=I,l={productId:m.id,productTitle:m.title,variantId:a.id,variantName:a.name,sku:a.sku},f={variantId:a.id};let j=!1;o!==void 0&&o!==a.price&&(l.priceChange={from:a.price||0,to:o},f.newPrice=o,j=!0),n!==void 0&&n!==a.cost&&(l.costChange={from:a.cost||0,to:n},f.newCost=n,j=!0),i!==void 0&&i!==a.stock&&(l.stockChange={from:a.stock,to:i},f.newStock=i,j=!0),j?(q.push(l),$.push(f)):B++}}),_(q),P(H),z(B),A($),c("preview")}catch(T){c("error"),u(T.message||"Error desconocido al procesar el archivo.")}},d.onerror=()=>{c("error"),u("No se pudo leer el archivo.")},d.readAsText(s)},M=s=>{s&&(s.type==="text/csv"||s.name.endsWith(".csv"))?se(s):(c("error"),u("Por favor, selecciona un archivo .csv válido."))},ae=s=>{s.preventDefault(),s.stopPropagation(),x(!1),M(s.dataTransfer.files?s.dataTransfer.files[0]:null)},re=()=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-3 text-sm bg-gray-900/50 rounded-lg border border-gray-700",children:[e.jsx("p",{className:"font-semibold mb-2",children:"Instrucciones:"}),e.jsxs("ul",{className:"list-disc list-inside text-gray-300 space-y-1 text-xs",children:[e.jsx("li",{children:'Exporta el CSV completo desde el panel financiero (Botón "Exportar CSV").'}),e.jsx("li",{children:"Abre el archivo y modifica **únicamente** los valores en las columnas `variant_price`, `variant_cost` y `variant_stock`."}),e.jsx("li",{children:"No modifiques ninguna otra columna, especialmente `variant_sku`."}),e.jsx("li",{children:"Guarda los cambios y sube el archivo modificado aquí."})]})]}),e.jsxs("div",{onDragEnter:s=>{s.preventDefault(),s.stopPropagation(),x(!0)},onDragLeave:s=>{s.preventDefault(),s.stopPropagation(),x(!1)},onDragOver:s=>{s.preventDefault(),s.stopPropagation()},onDrop:ae,className:`mt-4 flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg cursor-pointer transition-colors ${J?"border-purple-400 bg-purple-900/30":"border-gray-600 hover:border-gray-500"}`,onClick:()=>{var s;return(s=document.getElementById("csvFileInput"))==null?void 0:s.click()},children:[e.jsx(he,{size:40,className:"text-gray-400 mb-2"}),e.jsx("span",{className:"text-gray-300",children:"Arrastra y suelta el archivo .csv aquí"}),e.jsx("span",{className:"text-sm text-gray-500",children:"o haz clic para seleccionar"}),e.jsx("input",{id:"csvFileInput",type:"file",accept:".csv",className:"hidden",onChange:s=>M(s.target.files?s.target.files[0]:null)})]}),N==="error"&&e.jsx("p",{className:"mt-4 text-center text-red-400 bg-red-900/50 p-3 rounded-lg",children:X})]}),te=()=>e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap justify-around p-3 bg-gray-900/50 rounded-lg text-center text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"text-green-500"})," ",e.jsx("span",{className:"font-bold",children:v.length})," variantes para actualizar"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"text-red-500"})," ",e.jsx("span",{className:"font-bold",children:b.length})," filas con errores"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(L,{className:"text-gray-500"})," ",e.jsx("span",{className:"font-bold",children:Y})," filas sin cambios"]})]}),v.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2 text-gray-300",children:"Previsualización de Cambios:"}),e.jsx("div",{className:"max-h-60 overflow-y-auto bg-gray-900/80 p-2 rounded-lg border border-gray-700 space-y-2",children:v.map(s=>e.jsxs("div",{className:"p-2 bg-gray-800/70 rounded",children:[e.jsxs("p",{className:"font-bold text-sm",children:[s.productTitle," ",e.jsxs("span",{className:"text-purple-400",children:["(",s.variantName,")"]})]}),e.jsxs("div",{className:"text-xs text-gray-400 grid grid-cols-3 gap-x-2",children:[s.priceChange&&e.jsxs("span",{children:["Precio: ",s.priceChange.from," ",e.jsx(D,{size:12,className:"inline"})," ",s.priceChange.to]}),s.costChange&&e.jsxs("span",{children:["Costo: ",s.costChange.from," ",e.jsx(D,{size:12,className:"inline"})," ",s.costChange.to]}),s.stockChange&&e.jsxs("span",{className:"flex items-center gap-1",children:["Stock: ",s.stockChange.from," ",e.jsx(D,{size:12,className:"inline"})," ",s.stockChange.to," ",e.jsx("span",{title:"Se creará un ajuste de historial",children:e.jsx(de,{size:12,className:"text-yellow-400"})})]})]})]},s.variantId))})]}),b.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold mb-2 text-yellow-400 flex items-center gap-2",children:[e.jsx(me,{size:18})," Errores (filas ignoradas):"]}),e.jsx("div",{className:"max-h-32 overflow-y-auto bg-gray-900/80 p-2 rounded-lg border border-gray-700",children:e.jsx("ul",{className:"text-xs space-y-1",children:b.map(s=>e.jsxs("li",{children:["Fila ",s.rowIndex,": ",e.jsx("span",{className:"text-red-400",children:s.errors.join(", ")})]},s.rowIndex))})})]}),v.length===0&&e.jsx("p",{className:"text-center text-yellow-400 bg-yellow-900/50 p-4 rounded-lg",children:"No se encontraron cambios válidos para aplicar. Revisa tu archivo CSV."})]});return e.jsxs(pe,{isOpen:O,onClose:R,title:"Importar y Actualizar desde CSV",size:"lg",children:[e.jsx("div",{className:"p-6 space-y-4",children:N==="preview"?te():re()}),e.jsxs("footer",{className:"flex justify-end gap-4 p-4 border-t border-gray-700",children:[e.jsx("button",{type:"button",onClick:R,className:"py-2 px-4 bg-gray-600 hover:bg-gray-500 rounded-md transition-colors",children:"Cancelar"}),N==="preview"&&e.jsxs("button",{type:"button",onClick:()=>W(y),disabled:y.length===0,className:"py-2 px-4 bg-brand-purple hover:bg-purple-600 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:["Confirmar y Aplicar ",y.length," Cambio(s)"]})]})]})};export{je as default};
